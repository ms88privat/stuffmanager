"use strict";var _get=function e(t,r,a){var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,a)}if("value"in n&&n.writable)return n.value;var i=n.get;return void 0===i?void 0:i.call(a)},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},_prototypeProperties=function(e,t,r){t&&Object.defineProperties(e,t),r&&Object.defineProperties(e.prototype,r)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};!function(e,t){function r(e){var t=e.length;Object.keys(localStorage).forEach(function(r){r.substring(0,t)==e&&localStorage.removeItem(r)})}function a(e,t){"now"===e&&(e=(new Date).getTime()),t>e&&e.setDate(e.getDate()+1);var r=e-t;return r}e.module("stuffmanager",[]).provider("facilityManager",function(){var a=[],n=[],o="myApp";this.appPrefix=function(e){o=e},this.$get=["$q",function(){var i=function(){function i(e){var r=void 0===arguments[1]?{}:arguments[1],s=r.cache,u=void 0===s?!0:s,c=r.store,l=void 0===c?!1:c,d=r.resource,h=void 0===d?!1:d,f=r.primId,p=void 0===f?"id":f,v=r.domains,g=void 0===v?[]:v;if(_classCallCheck(this,i),!("string"==typeof e||e instanceof String))throw'facilityManager Instance: No "name" specified';if(-1!==t.indexOf(n,e))throw"facilityManager Instance: Duplicate Name - Every instance should have a unique name";n.push(e),this.name=o+e,this.cache=u,this.store=l,this.resource=h,this.domains=g,this.primId=p,this.domains.push(this.resource?"RESOURCE":"FACILITY"),this.cached={},a.push(this)}return _prototypeProperties(i,{clear:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],r=e.domains,n=void 0===r?[]:r,o=e.cache,i=void 0===o?!0:o,s=e.storage,u=void 0===s?!0:s;0===n.length?t.forEach(a,function(e){e.clear({cache:i,storage:u})}):t.forEach(a,function(e){t.intersection(n,e.domains).length>0&&e.clear({cache:i,storage:u})})},writable:!0,configurable:!0}},{destroy:{value:function(){t.without(a,this)},writable:!0,configurable:!0},save:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],t=e.key,r=e.data;return this.cache?(this.store&&this.saveToStorage(t,r),this.saveToCache(t,r)):void 0},writable:!0,configurable:!0},get:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],t=e.id,r=e.key,a=this.getFromCache(r);return!a&&this.store&&(a=this.saveToCache(r,this.getFromStore(r))),t&&a&&(t=parseInt(t),a=this.getById(t,a)),a},writable:!0,configurable:!0},getById:{value:function(e,r){if(r instanceof Array){var a={};return a[this.primId]=e,t.find(r,a)}},writable:!0,configurable:!0},add:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],r=e.key,a=e.data,n=i.prototype.get.call(this,{key:r});if(n){if(!t.isArray(n))throw"add() failed: presentData is not an array";n=n.concat(a)}else n=[],n=n.concat(a);return i.prototype.save.call(this,{key:r,data:n})},writable:!0,configurable:!0},removeById:{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.id,n=r.key;if(!a)throw"removeById() has no id specified";var o=i.prototype.get.call(this,{key:n});if(o){if(!t.isArray(o))throw"removeById() failed: presentData is not an array";a=parseInt(a);var s=t.remove(o,function(t){return t[e.primId]===a?!0:void 0});if(s){var u=i.prototype.save.call(this,{key:n,data:o});return u}return console.warn("removeById(): no match found -> no data removedById",a),o}},writable:!0,configurable:!0},update:{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.key,n=r.data,o=i.prototype.get.call(this,{key:a}),s=!1;if(n.hasOwnProperty(this.primId)&&t.isArray(o)){s=!0;var u=this.getById(n[this.primId],o);u?t.assign(u,n):console.warn("update() CASE 1: no match found -> no data updated or added! not found:",n)}if(t.isPlainObject(n)&&t.isPlainObject(o)&&(s=!0,t.assign(o,n)),t.isArray(n)&&t.isArray(o)){s=!0;var c={};t.forEach(n,function(r){c[e.primId]=r[e.primId];var a=t.find(o,c);a?t.assign(a,r):console.warn("update() CASE 3: no match found -> data NOT updated or added! not found:",r)})}if(!s)throw"update() was not possible - maybe there is no use case for it with the given and fetched data - re save() instead?";return i.prototype.save.call(this,{key:a,data:o})},writable:!0,configurable:!0},saveToCache:{value:function(e,t){return e=this.name+e,this.cached[e]=t,this.cached[e]},writable:!0,configurable:!0},saveToStorage:{value:function(t,r){return t=this.name+t,localStorage.setItem(t,e.toJson(r))},writable:!0,configurable:!0},getFromCache:{value:function(e){return e=this.name+e,this.cached[e]},writable:!0,configurable:!0},getFromStore:{value:function(t){return t=this.name+t,e.fromJson(localStorage.getItem(t))},writable:!0,configurable:!0},clear:{value:function(){var e=this,a=void 0===arguments[0]?{}:arguments[0],n=a.keys,o=void 0===n?[]:n,i=a.cache,s=void 0===i?!0:i,u=a.storage,c=void 0===u?!0:u;0===o.length?(s&&(this.cached={}),c&&r(this.name)):t.forEach(o,function(t){s&&delete e.cached[e.name+t],c&&r(e.name+t)})},writable:!0,configurable:!0}}),i}();return{create:function(e,t){return new i(e,t)},"class":i,clear:i.clear}}]}).provider("resourceManager",function(){var r=5e3;this.THROTTLE_TIME=function(e){r=e},this.$get=["$q","$rootScope","$http","facilityManager",function(n,o,i,s){function u(e,t,r,a){var n={method:e,url:t,params:r,data:a,transformResponse:[f].concat(i.defaults.transformResponse)};return c(n)}function c(e){return e.url=l(e.url,e.params,e.data),i(e)}function l(e,t,r){return t=t||{},r=r||{},e=e.replace(/(\(\s*|\s*\)|\s*\|\s*)/g,""),e=e.replace(/:([a-z]\w*)/gi,function(e,a){return d(r,t,a)||""}),e=e.replace(/(^|[^:])[\/]{2,}/g,"$1/"),e=e.replace(/\/+$/i,"")}function d(e,t,r,a){for(var n=Array.prototype.slice.call(arguments),a=n.pop(),o=null;o=n.shift();)if(o.hasOwnProperty(a))return h(o,a)}function h(e,t){var r=e[t];return delete e[t],r}var f=function(e,r){return t.has(r,"status")&&o.$broadcast("STUFFMANAGER:SERVER_TRANSFER_HAPPENED",r().date),e},p=function(e,t){console.warn("errorHandler",e,t),o.$broadcast("STUFFMANAGER:HTTP_ERROR",e,t)},v=function(o){function i(e){var t=void 0===arguments[1]?{}:arguments[1],a=t.cache,n=void 0===a?!0:a,o=t.store,s=void 0===o?!1:o,u=t.primId,c=void 0===u?"id":u,l=t.domains,d=void 0===l?[]:l,h=t.parse,f=void 0===h?!1:h,v=t.throttleTime,g=void 0===v?r:v,m=t.errorHandler,y=void 0===m?p:m,b=t.url;if(_classCallCheck(this,i),!("string"==typeof b||b instanceof String))throw'resourceManager Instance: No "url" specified';this.url=b,this.parse=f,this.throttleTime=g,this.errorHandler=y,_get(Object.getPrototypeOf(i.prototype),"constructor",this).call(this,e,{cache:n,store:s,resource:!0,primId:c,domains:d}),this.request={},this.requestTime={}}return _inherits(i,o),_prototypeProperties(i,null,{throwErr:{value:function(e){var t=function(){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.throwErr,o=void 0===a?{}:a,i={timeout:3e3,code:404};t.defaults(o,i);var s={};return s.status=o.code,$timeout(function(){return e.errorHandler&&e.errorHandler(e.name,s),n.reject("Error "+name)},o.timeout)}),writable:!0,configurable:!0},fetch:{value:function(){var t=this,r=void 0===arguments[0]?{}:arguments[0],o=r.url,s=void 0===o?this.url:o,c=r.params,l=void 0===c?{}:c,d=r.key,h=r.reload,f=void 0===h?!1:h,p=this;if(!f)var v=_get(Object.getPrototypeOf(i.prototype),"get",this).call(this,{key:d,id:l.id});if(v)return n.when(v);var g=e.toJson(s)+e.toJson(l),m=a("now",this.requestTime[g]),y=function(e){return _get(Object.getPrototypeOf(i.prototype),"save",p).call(p,{data:e,key:d}),e};return(!m||m>this.throttleTime)&&(console.log("get() ",this.name),this.requestTime[g]=(new Date).getTime(),this.request[g]=u("GET",s,l).then(function(e){return t.parseResponse(e)}).then(y)["catch"](function(e){return t.errorResponse(e)})),this.request[g]},writable:!0,configurable:!0},create:{value:function(){var e=this,t=void 0===arguments[0]?{}:arguments[0],r=t.params,a=void 0===r?{}:r,n=t.data,o=t.url,s=void 0===o?this.url:o,c=t.key,l=this;n.hasOwnProperty(this.primId)&&console.warn("CREATE() data has a id already?");var d=function(e){return _get(Object.getPrototypeOf(i.prototype),"add",l).call(l,{data:e,key:c}),e};return u("POST",s,a,n).then(function(t){return e.parseResponse(t)}).then(d)["catch"](function(t){return e.errorResponse(t)})},writable:!0,configurable:!0},put:{value:function(){var e=this,t=void 0===arguments[0]?{}:arguments[0],r=t.params,a=void 0===r?{}:r,n=t.data,o=t.url,s=void 0===o?this.url:o,c=t.key,l=this,d=function(e){return _get(Object.getPrototypeOf(i.prototype),"update",l).call(l,{data:e,key:c}),e};return u("PUT",s,a,n).then(function(t){return e.parseResponse(t)}).then(d)["catch"](function(t){return e.errorResponse(t)})},writable:!0,configurable:!0},"delete":{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.url,n=void 0===a?this.url:a,o=r.params,s=r.key,c=this,l=t.pick(o,"id").id,d=function(){return _get(Object.getPrototypeOf(i.prototype),"removeById",c).call(c,{key:s,id:l})};return u("DELETE",n,o).then(d)["catch"](function(t){return e.errorResponse(t)})},writable:!0,configurable:!0},parseResponse:{value:function(t){return t=t.data,console.log("parse:",t),"string"==typeof this.parse?t=t[this.parse]:e.isFunction(this.parse)===!0&&(t=this.parse(t)),t},writable:!0,configurable:!0},errorResponse:{value:function(e){return this.errorHandler&&this.errorHandler(this.name,e),n.reject(e)},writable:!0,configurable:!0}}),i}(s["class"]);return{create:function(e,t){return new v(e,t)},"class":v,clear:s["class"].clear,TRANSFORM:f,ERROR_HANDLER:p}}]})}(window.angular,window._);