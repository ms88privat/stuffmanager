"use strict";var _get=function e(t,r,a){var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,a)}if("value"in n&&n.writable)return n.value;var o=n.get;return void 0===o?void 0:o.call(a)},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},_prototypeProperties=function(e,t,r){t&&Object.defineProperties(e,t),r&&Object.defineProperties(e.prototype,r)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};!function(e,t){function r(e){var t=e.length;Object.keys(localStorage).forEach(function(r){r.substring(0,t)==e&&localStorage.removeItem(r)})}function a(e,t){"now"===e&&(e=(new Date).getTime()),t>e&&e.setDate(e.getDate()+1);var r=e-t;return r}e.module("stuffmanager",[]).provider("facilityManager",function(){var a=[],n=[],i="myApp";this.appPrefix=function(e){i=e},this.$get=["$q",function(){var o=function(){function o(e){var r=void 0===arguments[1]?{}:arguments[1],s=r.cache,c=void 0===s?!0:s,u=r.store,l=void 0===u?!1:u,d=r.resource,h=void 0===d?!1:d,f=r.primId,p=void 0===f?"id":f,v=r.domains,g=void 0===v?[]:v;if(_classCallCheck(this,o),!("string"==typeof e||e instanceof String))throw'facilityManager Instance: No "name" specified';if(-1!==t.indexOf(n,e))throw"facilityManager Instance: Duplicate Name - Every instance should have a unique name";n.push(e),this.name=i+e,this.cache=c,this.store=l,this.resource=h,this.domains=g,this.primId=p,this.domains.push(this.resource?"RESOURCE":"FACILITY"),this.cached={},a.push(this)}return _prototypeProperties(o,{getInstanceByName:{value:function(e){var r=t.find(a,{name:e});return console.log("instanceName",e,a,r),r},writable:!0,configurable:!0},clear:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],r=e.domains,n=void 0===r?[]:r,i=e.cache,o=void 0===i?!0:i,s=e.storage,c=void 0===s?!0:s;0===n.length?t.forEach(a,function(e){e.clear({cache:o,storage:c})}):t.forEach(a,function(e){t.intersection(n,e.domains).length>0&&e.clear({cache:o,storage:c})})},writable:!0,configurable:!0}},{destroy:{value:function(){t.without(a,this)},writable:!0,configurable:!0},save:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],t=e.key,r=e.data;return this.cache?(this.store&&r&&this.saveToStorage(t,r),this.saveToCache(t,r)):r},writable:!0,configurable:!0},get:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],t=e.id,r=e.key,a=this.getFromCache(r);return!a&&this.store&&(a=this.saveToCache(r,this.getFromStore(r))),t&&a?(t=parseInt(t),this.getById(t,a)):a},writable:!0,configurable:!0},getById:{value:function(e,r){if(r instanceof Array){var a={};return a[this.primId]=e,t.find(r,a)}return console.warn("getById: data is not an instanceof Array! returning the whole data instead",r),r},writable:!0,configurable:!0},add:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],r=e.key,a=e.data,n=o.prototype.get.call(this,{key:r});if(console.log("presentData",this.name,n),n){if(!t.isArray(n))throw"add() failed: presentData is not an array";n=n.concat(a),t.uniq(n,this.primId)}else n=[],n=n.concat(a);return o.prototype.save.call(this,{key:r,data:n})},writable:!0,configurable:!0},removeById:{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.id,n=r.key;if(!a)throw"removeById() has no id specified";var i=o.prototype.get.call(this,{key:n});if(i){if(!t.isArray(i))throw"removeById() failed: presentData is not an array";a=parseInt(a);var s=t.remove(i,function(t){return t[e.primId]===a?!0:void 0});if(s){var c=o.prototype.save.call(this,{key:n,data:i});return c}return console.warn("removeById(): no match found -> no data removedById",a),i}},writable:!0,configurable:!0},update:{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.key,n=r.data,i=o.prototype.get.call(this,{key:a});if(!i)return o.prototype.add.call(this,{key:a,data:n});var s=!1;if(n.hasOwnProperty(this.primId)&&t.isArray(i)){s=!0;var c=this.getById(n[this.primId],i);if(!c)return console.warn("update() CASE 1: no match found -> data added",n),o.prototype.add.call(this,{key:a,data:n});t.assign(c,n)}if(t.isPlainObject(n)&&t.isPlainObject(i)&&(s=!0,t.assign(i,n)),t.isArray(n)&&t.isArray(i)){s=!0;var u={};t.forEach(n,function(r){u[e.primId]=r[e.primId];var n=t.find(i,u);return n?void t.assign(n,r):(console.warn("update() CASE 3: no match found -> data added",r),o.prototype.add.call(e,{key:a,data:r}))})}if(!s)throw"update() was not possible - maybe there is no use case for it with the given and fetched data - re save() instead?";return o.prototype.save.call(this,{key:a,data:i})},writable:!0,configurable:!0},saveToCache:{value:function(e,t){return e=e?this.name+e:this.name,this.cached[e]=t,this.cached[e]},writable:!0,configurable:!0},saveToStorage:{value:function(t,r){return t=t?this.name+t:this.name,localStorage.setItem(t,e.toJson(r))},writable:!0,configurable:!0},getFromCache:{value:function(e){return e=e?this.name+e:this.name,this.cached[e]},writable:!0,configurable:!0},getFromStore:{value:function(t){return t=t?this.name+t:this.name,e.fromJson(localStorage.getItem(t))},writable:!0,configurable:!0},clear:{value:function(){var e=this,a=void 0===arguments[0]?{}:arguments[0],n=a.key,i=a.keys,o=void 0===i?[]:i,s=a.cache,c=void 0===s?!0:s,u=a.storage,l=void 0===u?!0:u;n?(c&&delete this.cached[this.name+n],l&&r(this.name+n)):0===o.length?(c&&(this.cached={}),l&&r(this.name)):t.forEach(o,function(t){c&&delete e.cached[e.name+t],l&&r(e.name+t)})},writable:!0,configurable:!0}}),o}();return{create:function(e,t){return new o(e,t)},"class":o,clear:o.clear,getInstanceByName:o.getInstanceByName}}]}).provider("resourceManager",function(){var r=5e3;this.THROTTLE_TIME=function(e){r=e},this.$get=["$q","$rootScope","$http","$timeout","facilityManager",function(n,i,o,s,c){function u(e){return e}function l(e,t){console.warn("errorHandler",e,t),i.$broadcast("STUFFMANAGER:HTTP_ERROR",e,t)}function d(e,t,r,a){var n={method:e,url:t,params:r,data:a,transformResponse:[g.TRANSFORM].concat(o.defaults.transformResponse)};return h(n)}function h(e){return e.url=f(e.url,e.params,e.data),o(e)}function f(e,t,r){return t=t||{},r=r||{},e=e.replace(/(\(\s*|\s*\)|\s*\|\s*)/g,""),e=e.replace(/:([a-z]\w*)/gi,function(e,a){return p(r,t,a)||""}),e=e.replace(/(^|[^:])[\/]{2,}/g,"$1/"),e=e.replace(/\/+$/i,"")}function p(e,t,r,a){function n(e,t){var r=e[t];return s||delete e[t],r}for(var i=Array.prototype.slice.call(arguments),a=i.pop(),o=null,s=!0;o=i.shift();){if(o.hasOwnProperty(a))return n(o,a);s=!1}}var v=function(i){function o(e){var t=void 0===arguments[1]?{}:arguments[1],a=t.cache,n=void 0===a?!0:a,i=t.store,s=void 0===i?!1:i,c=t.primId,u=void 0===c?"id":c,l=t.domains,d=void 0===l?[]:l,h=t.parse,f=void 0===h?!1:h,p=t.throttleTime,v=void 0===p?r:p,m=t.errorHandler,y=void 0===m?g.ERROR_HANDLER:m,b=t.url;if(_classCallCheck(this,o),!("string"==typeof b||b instanceof String))throw'resourceManager Instance: No "url" specified';this.url=b,this.parse=f,this.throttleTime=v,this.errorHandler=y,_get(Object.getPrototypeOf(o.prototype),"constructor",this).call(this,e,{cache:n,store:s,resource:!0,primId:u,domains:d}),this.requests={},this.requestTimes={}}return _inherits(o,i),_prototypeProperties(o,{reFetch:{value:function(e){t.forEach(e,function(e){c["class"].getInstanceByName(e.instanceName).fetch(e)})},writable:!0,configurable:!0},resetThrottle:{value:function(){this.requests={},this.requestTimes={}},writable:!0,configurable:!0}},{throwErr:{value:function(e){var t=function(){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.throwErr,n=void 0===a?{}:a,i=r.rejectIfError,o=void 0===i?!0:i,c={timeout:3e3,code:404};t.defaults(n,c);var u={};u.status=n.code;var l={instanceName:"myAppideas",url:"throw/:id",params:{id:666},reload:!0,rejectIfError:!1,key:"yolo"};return s(function(){return e.errorResponse(u,o,l)},n.timeout)}),writable:!0,configurable:!0},fetch:{value:function(){var r=this,i=void 0===arguments[0]?{}:arguments[0],s=i.url,c=void 0===s?this.url:s,u=i.params,l=void 0===u?{}:u,h=i.key,f=i.reload,p=void 0===f?!1:f,v=i.rejectIfError,g=void 0===v?!0:v,m=this;if(!p)var y=_get(Object.getPrototypeOf(o.prototype),"get",this).call(this,{key:h,id:l.id});if(y)return n.when(y);var b=t.pick(l,"id").id||b,w=e.toJson(c)+e.toJson(l),I={instanceName:this.name,url:c,params:e.copy(l),key:h,reload:!0,rejectIfError:!1},E=a("now",this.requestTimes[w]),O=function(e){return b?(console.log("fetch(): update instead of save",b),r.getById(b,_get(Object.getPrototypeOf(o.prototype),"update",m).call(m,{data:e,key:h}))):_get(Object.getPrototypeOf(o.prototype),"save",m).call(m,{data:e,key:h})};return!E||E>this.throttleTime?(console.log("fetch() ",this.name),this.requestTimes[w]=(new Date).getTime(),this.requests[w]=d("GET",c,l).then(function(e){return r.parseResponse(e)}).then(O)["catch"](function(e){return r.errorResponse(e,g,I)})):console.log("throttle",this.name),this.requests[w]},writable:!0,configurable:!0},create:{value:function(){var e=this,t=void 0===arguments[0]?{}:arguments[0],r=t.params,a=void 0===r?{}:r,n=t.data,i=t.url,s=void 0===i?this.url:i,c=t.rejectIfError,u=void 0===c?!0:c,l=t.key,h=this;n.hasOwnProperty(this.primId)&&console.warn("CREATE() data has a id already?");var f=function(e){return _get(Object.getPrototypeOf(o.prototype),"add",h).call(h,{data:e,key:l}),e};return d("POST",s,a,n).then(function(t){return e.parseResponse(t)}).then(f)["catch"](function(t){return e.errorResponse(t,u)})},writable:!0,configurable:!0},put:{value:function(){var e=this,t=void 0===arguments[0]?{}:arguments[0],r=t.params,a=void 0===r?{}:r,n=t.data,i=t.url,s=void 0===i?this.url:i,c=t.rejectIfError,u=void 0===c?!0:c,l=t.key,h=this,f=function(e){return _get(Object.getPrototypeOf(o.prototype),"update",h).call(h,{data:e,key:l}),e};return d("PUT",s,a,n).then(function(t){return e.parseResponse(t)}).then(f)["catch"](function(t){return e.errorResponse(t,u)})},writable:!0,configurable:!0},"delete":{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.url,n=void 0===a?this.url:a,i=r.rejectIfError,s=void 0===i?!0:i,c=r.params,u=r.key,l=r.id,h=this,l=t.pick(c,"id").id||l,f=function(){return _get(Object.getPrototypeOf(o.prototype),"removeById",h).call(h,{key:u,id:l})};return d("DELETE",n,c).then(f)["catch"](function(t){return e.errorResponse(t,s)})},writable:!0,configurable:!0},parseResponse:{value:function(t){return t=t.data,"string"==typeof this.parse?t=t[this.parse]:e.isFunction(this.parse)===!0&&(t=this.parse(t)),t},writable:!0,configurable:!0},errorResponse:{value:function(e,t,r){return this.errorHandler&&this.errorHandler(this.name,e,r),t?n.reject(e):(e._isError=!0,n.when(e))},writable:!0,configurable:!0}}),o}(c["class"]),g={create:function(e,t){return new v(e,t)},"class":v,clear:c["class"].clear,getInstanceByName:c["class"].getInstanceByName,reFetch:v.reFetch,resetThrottle:v.resetThrottle,TRANSFORM:u,ERROR_HANDLER:l};return g}]})}(window.angular,window._);