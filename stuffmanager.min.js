"use strict";var _get=function e(t,r,a){var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,a)}if("value"in n&&n.writable)return n.value;var o=n.get;return void 0===o?void 0:o.call(a)},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},_prototypeProperties=function(e,t,r){t&&Object.defineProperties(e,t),r&&Object.defineProperties(e.prototype,r)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};!function(e,t){function r(e){var t=e.length;Object.keys(localStorage).forEach(function(r){r.substring(0,t)==e&&localStorage.removeItem(r)})}function a(e,t){"now"===e&&(e=(new Date).getTime()),t>e&&e.setDate(e.getDate()+1);var r=e-t;return r}e.module("stuffmanager",[]).provider("facilityManager",function(){var a=[],n=[],i="myApp";this.appPrefix=function(e){i=e},this.$get=["$q",function(){var o=function(){function o(e){var r=void 0===arguments[1]?{}:arguments[1],s=r.cache,u=void 0===s?!0:s,c=r.store,l=void 0===c?!1:c,d=r.resource,h=void 0===d?!1:d,f=r.primId,p=void 0===f?"id":f,v=r.domains,g=void 0===v?[]:v;if(_classCallCheck(this,o),!("string"==typeof e||e instanceof String))throw'facilityManager Instance: No "name" specified';if(-1!==t.indexOf(n,e))throw"facilityManager Instance: Duplicate Name - Every instance should have a unique name";n.push(e),this.name=i+e,this.cache=u,this.store=l,this.resource=h,this.domains=g,this.primId=p,this.domains.push(this.resource?"RESOURCE":"FACILITY"),this.cached={},a.push(this)}return _prototypeProperties(o,{clear:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],r=e.domains,n=void 0===r?[]:r,i=e.cache,o=void 0===i?!0:i,s=e.storage,u=void 0===s?!0:s;0===n.length?t.forEach(a,function(e){e.clear({cache:o,storage:u})}):t.forEach(a,function(e){t.intersection(n,e.domains).length>0&&e.clear({cache:o,storage:u})})},writable:!0,configurable:!0}},{destroy:{value:function(){t.without(a,this)},writable:!0,configurable:!0},save:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],t=e.key,r=e.data;return this.cache?(this.store&&r&&this.saveToStorage(t,r),this.saveToCache(t,r)):void 0},writable:!0,configurable:!0},get:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],t=e.id,r=e.key,a=this.getFromCache(r);return!a&&this.store&&(a=this.saveToCache(r,this.getFromStore(r))),t&&a&&(t=parseInt(t),a=this.getById(t,a)),a},writable:!0,configurable:!0},getById:{value:function(e,r){if(r instanceof Array){var a={};return a[this.primId]=e,t.find(r,a)}},writable:!0,configurable:!0},add:{value:function(){var e=void 0===arguments[0]?{}:arguments[0],r=e.key,a=e.data,n=o.prototype.get.call(this,{key:r});if(n){if(!t.isArray(n))throw"add() failed: presentData is not an array";n=n.concat(a),t.uniq(n,this.primId)}else n=[],n=n.concat(a);return o.prototype.save.call(this,{key:r,data:n})},writable:!0,configurable:!0},removeById:{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.id,n=r.key;if(!a)throw"removeById() has no id specified";var i=o.prototype.get.call(this,{key:n});if(i){if(!t.isArray(i))throw"removeById() failed: presentData is not an array";a=parseInt(a);var s=t.remove(i,function(t){return t[e.primId]===a?!0:void 0});if(s){var u=o.prototype.save.call(this,{key:n,data:i});return u}return console.warn("removeById(): no match found -> no data removedById",a),i}},writable:!0,configurable:!0},update:{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.key,n=r.data,i=o.prototype.get.call(this,{key:a});if(!i)return o.prototype.add.call(this,{key:a,data:n});var s=!1;if(n.hasOwnProperty(this.primId)&&t.isArray(i)){s=!0;var u=this.getById(n[this.primId],i);if(!u)return console.warn("update() CASE 1: no match found -> data added",n),o.prototype.add.call(this,{key:a,data:n});t.assign(u,n)}if(t.isPlainObject(n)&&t.isPlainObject(i)&&(s=!0,t.assign(i,n)),t.isArray(n)&&t.isArray(i)){s=!0;var c={};t.forEach(n,function(r){c[e.primId]=r[e.primId];var n=t.find(i,c);n?t.assign(n,r):(console.warn("update() CASE 3: no match found -> -> data added",r),o.prototype.add.call(e,{key:a,data:r}))})}if(!s)throw"update() was not possible - maybe there is no use case for it with the given and fetched data - re save() instead?";return o.prototype.save.call(this,{key:a,data:i})},writable:!0,configurable:!0},saveToCache:{value:function(e,t){return e=e?this.name+e:this.name,this.cached[e]=t,this.cached[e]},writable:!0,configurable:!0},saveToStorage:{value:function(t,r){return t=t?this.name+t:this.name,localStorage.setItem(t,e.toJson(r))},writable:!0,configurable:!0},getFromCache:{value:function(e){return e=e?this.name+e:this.name,this.cached[e]},writable:!0,configurable:!0},getFromStore:{value:function(t){return t=t?this.name+t:this.name,e.fromJson(localStorage.getItem(t))},writable:!0,configurable:!0},clear:{value:function(){var e=this,a=void 0===arguments[0]?{}:arguments[0],n=a.key,i=a.keys,o=void 0===i?[]:i,s=a.cache,u=void 0===s?!0:s,c=a.storage,l=void 0===c?!0:c;n&&(u&&delete this.cached[this.name+n],l&&r(this.name+n)),0===o.length?(u&&(this.cached={}),l&&r(this.name)):t.forEach(o,function(t){u&&delete e.cached[e.name+t],l&&r(e.name+t)})},writable:!0,configurable:!0}}),o}();return{create:function(e,t){return new o(e,t)},"class":o,clear:o.clear}}]}).provider("resourceManager",function(){var r=5e3;this.THROTTLE_TIME=function(e){r=e},this.$get=["$q","$rootScope","$http","$timeout","facilityManager",function(n,i,o,s,u){function c(e){return e}function l(e,t){console.warn("errorHandler",e,t),i.$broadcast("STUFFMANAGER:HTTP_ERROR",e,t)}function d(e,t,r,a){var n={method:e,url:t,params:r,data:a,transformResponse:[g.TRANSFORM].concat(o.defaults.transformResponse)};return h(n)}function h(e){return e.url=f(e.url,e.params,e.data),o(e)}function f(e,t,r){return t=t||{},r=r||{},e=e.replace(/(\(\s*|\s*\)|\s*\|\s*)/g,""),e=e.replace(/:([a-z]\w*)/gi,function(e,a){return p(r,t,a)||""}),e=e.replace(/(^|[^:])[\/]{2,}/g,"$1/"),e=e.replace(/\/+$/i,"")}function p(e,t,r,a){function n(e,t){var r=e[t];return s||delete e[t],r}for(var i=Array.prototype.slice.call(arguments),a=i.pop(),o=null,s=!0;o=i.shift();){if(o.hasOwnProperty(a))return n(o,a);s=!1}}var v=function(i){function o(e){var t=void 0===arguments[1]?{}:arguments[1],a=t.cache,n=void 0===a?!0:a,i=t.store,s=void 0===i?!1:i,u=t.primId,c=void 0===u?"id":u,l=t.domains,d=void 0===l?[]:l,h=t.parse,f=void 0===h?!1:h,p=t.throttleTime,v=void 0===p?r:p,m=t.errorHandler,y=void 0===m?g.ERROR_HANDLER:m,b=t.url;if(_classCallCheck(this,o),!("string"==typeof b||b instanceof String))throw'resourceManager Instance: No "url" specified';this.url=b,this.parse=f,this.throttleTime=v,this.errorHandler=y,_get(Object.getPrototypeOf(o.prototype),"constructor",this).call(this,e,{cache:n,store:s,resource:!0,primId:c,domains:d}),this.requests={},this.requestTimes={}}return _inherits(o,i),_prototypeProperties(o,null,{throwErr:{value:function(e){var t=function(){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.throwErr,i=void 0===a?{}:a,o={timeout:3e3,code:404};t.defaults(i,o);var u={};return u.status=i.code,s(function(){return e.errorHandler&&e.errorHandler(e.name,u),n.reject("Error "+name)},i.timeout)}),writable:!0,configurable:!0},fetch:{value:function(){var t=this,r=void 0===arguments[0]?{}:arguments[0],i=r.url,s=void 0===i?this.url:i,u=r.params,c=void 0===u?{}:u,l=r.key,h=r.reload,f=void 0===h?!1:h,p=this;if(!f)var v=_get(Object.getPrototypeOf(o.prototype),"get",this).call(this,{key:l,id:c.id});if(v)return n.when(v);var g=e.toJson(s)+e.toJson(c),m=a("now",this.requestTimes[g]),y=function(e){return _get(Object.getPrototypeOf(o.prototype),"save",p).call(p,{data:e,key:l}),e};return!m||m>this.throttleTime?(console.log("get() ",this.name),this.requestTimes[g]=(new Date).getTime(),this.requests[g]=d("GET",s,c).then(function(e){return t.parseResponse(e)}).then(y)["catch"](function(e){return t.errorResponse(e)})):console.log("throttle",this.name),this.requests[g]},writable:!0,configurable:!0},create:{value:function(){var e=this,t=void 0===arguments[0]?{}:arguments[0],r=t.params,a=void 0===r?{}:r,n=t.data,i=t.url,s=void 0===i?this.url:i,u=t.key,c=this;n.hasOwnProperty(this.primId)&&console.warn("CREATE() data has a id already?");var l=function(e){return _get(Object.getPrototypeOf(o.prototype),"add",c).call(c,{data:e,key:u}),e};return d("POST",s,a,n).then(function(t){return e.parseResponse(t)}).then(l)["catch"](function(t){return e.errorResponse(t)})},writable:!0,configurable:!0},put:{value:function(){var e=this,t=void 0===arguments[0]?{}:arguments[0],r=t.params,a=void 0===r?{}:r,n=t.data,i=t.url,s=void 0===i?this.url:i,u=t.key,c=this,l=function(e){return _get(Object.getPrototypeOf(o.prototype),"update",c).call(c,{data:e,key:u}),e};return d("PUT",s,a,n).then(function(t){return e.parseResponse(t)}).then(l)["catch"](function(t){return e.errorResponse(t)})},writable:!0,configurable:!0},"delete":{value:function(){var e=this,r=void 0===arguments[0]?{}:arguments[0],a=r.url,n=void 0===a?this.url:a,i=r.params,s=r.key,u=r.id,c=this,u=t.pick(i,"id").id||u,l=function(){return _get(Object.getPrototypeOf(o.prototype),"removeById",c).call(c,{key:s,id:u})};return d("DELETE",n,i).then(l)["catch"](function(t){return e.errorResponse(t)})},writable:!0,configurable:!0},parseResponse:{value:function(t){return t=t.data,"string"==typeof this.parse?t=t[this.parse]:e.isFunction(this.parse)===!0&&(t=this.parse(t)),t},writable:!0,configurable:!0},errorResponse:{value:function(e){return this.errorHandler&&this.errorHandler(this.name,e),n.reject(e)},writable:!0,configurable:!0}}),o}(u["class"]),g={create:function(e,t){return new v(e,t)},"class":v,clear:u["class"].clear,TRANSFORM:c,ERROR_HANDLER:l};return g}]})}(window.angular,window._);